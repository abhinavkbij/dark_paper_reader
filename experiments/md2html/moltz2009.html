<p><br># A GENERAL FRAMEWORK FOR AUTOMATIC DETECTION OF MATCHING LESIONS IN FOLLOW-UP CT </p>
<p>Jan Hendrik Moltz, Michael Schwier, Heinz-Otto Peitgen<br>Fraunhofer MEVIS - Institute for Medical Image Computing<br>Universit√§tsallee 29, 28359 Bremen, Germany</p>
<h4 id="abstract">Abstract</h4>
<p>In follow-up CT examinations of cancer patients, therapy success is evaluated by estimating the change in tumor size from diameter or volume comparison between corresponding lesions. We present an algorithm that automatizes the detection of matching lesions, given a baseline segmentation mask. It is generally applicable and does not need an organ mask or CAD findings, only a coarse registration of the datasets is required. In the first step, lesion candidates are identified in a local area based on gray value filtering and detection of circular structures using a Hough transform. On all candidate voxels, a template matching is performed minimizing normalized cross-correlation. The method was evaluated on clinical follow-up data comprising 94 lung nodules, 107 liver metastases, and 137 lymph nodes. The ratio of correctly detected lesions was $96 \%, 84 \%$ and $85 \%$, respectively, at an average computation time of 0.9 s per lesion on a standard PC.</p>
<p>Index Terms- Biomedical image processing, object detection, computed tomography, tumors.</p>
<h2 id="1introduction">1. INTRODUCTION</h2>
<p>When a tumor patient is treated with chemotherapy, followup CT examinations are conducted in intervals of three to six months in order to monitor the success of the therapy. One of the most important criteria is the change in tumor size. According to current standards, size is measured in terms of the largest axial diameter which is determined manually by the radiologist. Recent advances in medical image processing allow a computer-assisted 3d volumetry of tumors which has the potential to be more accurate and reproducible than a manual 1d measurement. Research in our group has focused on segmenting the most relevant entities in oncological routine: lung nodules, liver metastases, and enlarged lymph nodes [1]. Most of the current methods are semi-automatic and require a seed point or a line to be supplied by the user.</p>
<p>In a follow-up assessment, the radiologist has to identify the lesions that were measured in the baseline scan and perform volumetry on them. Matching lesions manually can be a time-consuming task because it implies visual comparison of two 3d datasets. Especially lymph nodes are often hard to find
and the relevant findings can be spread over different body regions. If the detection of matching lesions is performed as a preprocessing step, segmentations can be precomputed as well and the results are available immediately. This offers a potential to accelerate the radiological workflow.</p>
<p>Our goal is to find a seed point that is accurate enough to start a tumor segmentation in the follow-up image without any user interaction. This means that the point must be located inside the tumor. The algorithm needs a coarse registration of the two datasets as a preprocessing step and it uses the baseline segmentation masks, but in contrast to previous approaches it is independent of any organ-specific segmentation or CAD methods.</p>
<h2 id="2stateoftheart">2. STATE OF THE ART</h2>
<p>In previous research, two scenarios have to be distinguished. If the tumor positions in both scans are known, the remaining task is to identify the corresponding pairs. This has been done for lung nodules where automatic lesion detection works reliably. Different registration techniques can be applied and the matching problem breaks down to finding nodule pairs with the least Euclidean distance as presented by Betke et al. [2]. For other tumor entities, CAD is not stable enough yet.</p>
<p>In the second scenario, the tumor positions are known in the baseline scan only and this information is used to retrieve tumors in the follow-up scan. So far, some specialized algorithms for particular lesion types have been developed. For lung nodules, Wiemker et al. [3] segment the lungs and use lung volume percentiles to find the rough positions of the lesions in the follow-up scan which are then refined by block matching. Shi et al. [4] extract the rib centerlines from both scans and determine an affine transformation for them. Again, block matching is applied to obtain the final result. A method for liver metastases was proposed by Charnoz et al. [5]. They compute a deformation field for the liver based on vessel tree matching and apply it to the tumors.</p>
<p>All of the existing methods depend on organ-specific knowledge and are not generally applicable. To our knowledge, no algorithm for lymph node matching has been developed so far. The novelty of our contribution is a framework that assists follow-up examinations of arbitary tumor entities.<br>## 3. ALGORITHM OVERVIEW</p>
<p>The input to our algorithm is a baseline CT dataset, a followup CT dataset, a precomputed transformation between the two datasets and the baseline mask of the lesion. In our experiments, we used a global rigid registration which was good enough to define a computationally treatable search area for the lesion in most of the cases. As a seed point, we transform the center of gravity of the baseline mask to the follow-up dataset. The size of the search area is determined by two contrary effects: On the one hand, the risk of missing a lesion that is too far away from the seed point should be minimized, but on the other hand a large search area can contain similar lesions that might distract the algorithm. We defined the search area as a cube centered at the seed point with an edge length of $s=40 \mathrm{~mm}$ (Fig. 1(b)).</p>
<p>Our algorithm consists of two parts: First, we apply a local tumor candidate detection strategy which identifies possible lesions based on gray values and shape parameters. This step is largely independent of the baseline dataset. Second, a template matching is used to find the lesion candidate that is most similar to the baseline lesion. We apply the normalized cross-correlation similarity measure.</p>
<p>Since the template matching requires isotropic voxels and identical voxel sizes of the two datasets, we resample both images according to the following rule: The voxel size is set to 2 mm and reduced further until the bounding cube of the lesion covers at least $15^{3}$ voxels.</p>
<h2 id="4localtumorcandidatedetection">4. LOCAL TUMOR CANDIDATE DETECTION</h2>
<p>The concept of local tumor candidate detection was inspired by CAD algorithms that work on a single dataset with an organ segmentation but with no a priori information about the lesions. In our scenario we know the coarse location of a tumor, so we can restrict the detection to a local search area. However, this area might contain parts of different organs, so the challenges are slightly different than in traditional CAD.</p>
<h3 id="41grayvaluefiltering">4.1. Gray Value Filtering</h3>
<p>The local tumor candidate detection is based on two features: gray value and shape. In the first step, the voxels in the search area are filtered according to a simple thresholding criterion that is adapted depending on the lesion type. We propose thresholds for lung nodules, liver metastases and lymph nodes, but the framework can be extended easily.</p>
<p>For lung nodules, due to the high contrast to the lung parenchyma, a fixed lower threshold of -400 HU and no upper threshold can be used (Fig. 1(c)).</p>
<p>The gray value relations in the liver can vary depending on the state of the patient and the contrast agent phase, so the thresholds have to be determined adaptively. Assuming that the largest part of the search area consists of liver
<img src="img-0.jpeg" alt="img-0.jpeg"></p>
<p>Fig. 1. Illustration of the algorithm for a lung nodule. (a) Reference block from the baseline dataset. (b) Search area from the follow-up dataset. The center of this slice is the seed point. (c) Search area after thresholding and opening. (d) Search area after Hough transform and smoothing. (e) Search area after thresholding the Hough map. (f) Normalized crosscorrelation map of the search area. It is actually only evaluated under the mask from (e). The brightest spot corresponds to the lesion and it is detected correctly.
parenchyma, the highest histogram peak is regarded as a typical parenchyma value $p$. For hypodense lesions, all voxels between 10 HU and $p-15$ are chosen whereas the thresholds for hyperdense lesions are $p+15$ and 180 HU . The information about the lesion type is provided by the baseline segmentation. If it is not available, the union of both intervals can be used.</p>
<p>For lymph nodes, fixed thresholds cannot be used either but we know that they do not change their gray value structure significantly over time. Therefore we use the range of values that appear in the baseline image under the corresponding mask. This could also be used as a fallback procedure for other lesion types.<br>### 4.2. Detection of Circular Structures</p>
<p>Thresholding alone is not sufficient for detecting lesion candidates since other anatomical structures display similar gray values. The chest wall and the heart, for instance, show a similar density as lung nodules (Fig. 1(c)). The same is true for the intercostal muscles compared to hypodense liver metastases. Tumors, however, can be recognized by their compact roundish or ellipsoidal shape. Therefore we apply a Hough transform to the opened thresholding result to identify voxels with these characteristics and to separate them from larger, plane areas that are more likely to represent other structures. For performance reasons, we use a 2d Hough transform on axial slices and search for circles. Since the lesion may grow or shrink and its cross-sections differ in size on the constituent slices, we have to search for a rather wide range of radii. In our setting, we use a minimum radius of 0 and a maximum radius equal to the block size. This causes significant stripe artifacts in the Hough map which are reduced by a Gaussian smoothing (Fig. 1(d)). A relative threshold of $25 \%$ is applied to the Hough map, resulting in a binary image that shows the lesion candidates (Fig. 1(e)).</p>
<p>In many cases such as in Fig. 1, the local tumor candidate detection already identifies the coarse location of the tumor. However, there may be more than one lesion in the search area or other anatomical structures could respond to the gray value and shape criteria as well. Therefore a refinement step is needed that incorporates information from the baseline image and segmentation.</p>
<h2 id="5templatematching">5. TEMPLATE MATCHING</h2>
<p>In the second phase of our algorithm, we try to find the lesion candidate that is most similar to the lesion that was segmented in the baseline scan. We use a template matching approach with a block size $b$ depending on the size of the lesion. We compute the fitting cube of the bounding box of the baseline segmentation mask and enlarge it by a factor of 1.5 to account for growing lesions (Fig. 1(a)). In this scenario, the similarity measure has to be chosen carefully since we have to deal with tumors that have possibly changed their gray value structure due to therapy or variations in the image acquisition. We tried several of the standard similarity measures and found that zero-mean normalized cross correlation provided the best results.</p>
<p>Due to subtracting the mean values and to normalizing with the standard deviations, this measure gives a good response even if gray levels of the entire image or the gray value of the lesion compared to its surroundings have changed (Fig. 1(f)). Although it is not strictly scale-invariant, it also proved to be robust against moderate changes in size as they occur in our use case. The output of our algorithm is the maximum point of the correlation map masked with the local tumor candidate detection result.
<img src="img-1.jpeg" alt="img-1.jpeg"></p>
<p>Fig. 2. Examples of successful lesion matching. Left: baseline with reference point, right: follow-up with result point. (a) Growing lung nodule with a different position relative to the heart. (b) Growing liver metastasis in a highly metastasized liver. (c) Shrinking liver metastasis. (d) Stable lymph node surrounded by several similar structures.</p>
<h2 id="6results">6. RESULTS</h2>
<p>We performed an evaluation study for lung nodules, liver metastases, and lymph nodes. For all lesion types, we used clinical follow-up CT pairs with lesions segmented in both scans. Radiologists approved the quality of the segmentations and established the correspondences between the two<br>|  | Lung | Liver | Lymph |
| :--: | :--: | :--: | :--: |
| Number of lesions | 94 | 107 | 137 |
| Matching rate | $95.7 \%$ | $84.1 \%$ | $84.7 \%$ |
| Matching rate (TM) | $93.6 \%$ | $66.4 \%$ | $75.9 \%$ |
| Matching rate (RR) | $36.2 \%$ | $50.5 \%$ | $35.8 \%$ |
| Avg. dist. of mismatches | 6.9 mm | 2.4 mm | 2.2 mm |
| Avg. computation time | 0.83 s | 1.05 s | 0.87 s |
| Avg. comp. time (TM) | 48.99 s | 7.43 s | 8.87 s |
| Max. computation time | 4.00 s | 4.47 s | 3.06 s |</p>
<p>Table 1. Summary of evaluation results. (TM): Rigid registration and template matching only, (RR): rigid registration only. Computation times do not include registration.
datasets. A rigid registration between the follow-up pairs was precomputed and some cases were discarded where the resulting transformation was not satisfactory. We used 15 pairs of datasets with 94 lung nodules, 44 pairs of datasets with 107 mostly hypodense liver metastases, and 46 pairs of datasets with 137 enlarged lymph nodes in different body regions. The data was acquired in different hospitals and on different CT scanners. The detailed evaluation results can be found in Table 1. Figure 2 shows some successful examples.</p>
<p>We applied our algorithm and checked whether the result point was inside the follow-up lesion mask. This is the most important criterion if we want to start a segmentation in the follow-up scan automatically. The algorithm succeeded for 90 lung nodules, 90 liver metastases and 116 lymph nodes. The average computation time was 0.9 s per lesion on a PC with a 2.66 GHz Core2 Quad processor, with a maximum of 4.5 s . This performance would not be required for preprocessing but it allows interactive usage as well. A possible use case is inverse matching where the radiologist wants to find a lesion in the baseline scan that was not segmented before.</p>
<p>For the failed cases, we computed the distance between the point found by our algorithm and the mask. The distances average at 4 mm which is about the size of a typical lesion. This means that in case of a mismatch, the user can still be guided to a position close to the lesion where they can initialize the segmentation manually. The higher average distance for lung nodules can be explained by the fact that due to the good contrast in the lungs, a mismatch is most probably another lesion and not a similar structure close by.</p>
<p>To show the benefit of the local tumor candidate detection we computed the results with template matching alone as well and found that this does not only reduce the matching rate but increases computation time dramatically. Performing template matching on the entire search area is much more expensive than the local tumor detection which removes about $99 \%$ of the voxels in the search area. The effect is strongest for lung nodules since they are often small and a fine resolution is used. For comparison, Table 1 also shows the matching rate of the rigid registration with no further refinement.</p>
<h2 id="7discussion">7. DISCUSSION</h2>
<p>We presented an algorithm for general lesion matching in follow-up CT scans. In contrast to previous attempts, our method is not specialized for a certain lesion type and does not need any organ-specific registration or segmentation.</p>
<p>The evaluation showed the robustness and computational efficiency of our method. There is still some potential for improvements in the detection of liver metastases and lymph nodes by refining the thresholds or by employing further shape criteria. Furthermore, it would be desirable to have a mechanism to find mismatches automatically. The similarity values are spread irregularly over hits and misses so that no conclusions about the quality of a result can be drawn. So far, mismatches can only be detected by the subsequent segmentation algorithm that will fail if no tumor-like structure is present. For preprocessing, this is a feasible solution as the user can still be guided into the neighborhood of the lesion and mark it manually. By precomputing most of the segmentations and by assisting the navigation through the dataset, our contribution can help to accelerate the radiological workflow.</p>
<h2 id="8acknowledgment">8. ACKNOWLEDGMENT</h2>
<p>We thank Dr. Hendrik Bolte, Dr. Michael Fabel, Dr. Stephan Meier, Dr. Elena Peitgen, and Dr. Nanette Peitgen for supplying the segmentation masks and lesion correspondences that were used for the automatic tests of the algorithm. This work was supported by a research grant from Siemens Healthcare, Computed Tomography, Forchheim, Germany.</p>
<h2 id="9references">9. REFERENCES</h2>
<p>[1] J. H. Moltz, L. Bornemann et al., "Advanced segmentation techniques for lung nodules, liver metastases, and enlarged lymph nodes in CT scans," IEEE J. Sel. Topics Signal Proc., vol. 3, no. 1, pp. 122-134, 2009.
[2] M. Betke, H. Hong et al., "Landmark detection in the chest and registration of lung surfaces with an application to nodule registration," Medical Image Analysis, vol. 7, pp. 265-281, 2002.
[3] R. Wiemker, B. de Hoop et al., "Performance study of a globally elastic locally rigid matching algorithm for follow-up chest CT," in Proc. SPIE Medical Imaging, 2008, p. 691706.
[4] J. Shi, B. Sahiner et al., "Pulmonary nodule registration in serial CT scans based on rib anatomy and nodule template matching," Medical Physics, vol. 34, no. 4, pp. 13351347, 2007.
[5] A. Charnoz, V. Agnus et al., "Liver registration for the follow-up of hepatic tumors," in Proc. MICCAI, 2005, pp. 155-162.</p>